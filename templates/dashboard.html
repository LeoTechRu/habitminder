{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–í–∞—à–∏ –ø—Ä–∏–≤—ã—á–∫–∏</h1>
        <a href="{{ url_for('create_habit') }}" class="btn btn-success">
            + –ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞
        </a>
    </div>

    <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∞—Å—Ç–æ—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
    <div class="row g-4">
        {% for freq in ['daily', 'weekly', 'monthly'] %}
        <div class="col-12">
            <h3 class="text-{% if freq == 'daily' %}success{% elif freq == 'weekly' %}primary{% else %}warning{% endif %} mb-3">
                {% if freq == 'daily' %}üóì –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ
                {% elif freq == 'weekly' %}üìÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ
                {% else %}üìÜ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ{% endif %} –ø—Ä–∏–≤—ã—á–∫–∏
            </h3>
            
            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% for habit in habits if habit.frequency == freq %}
                <div class="col">
                    <div class="card h-100 border-{% if freq == 'daily' %}success{% elif freq == 'weekly' %}primary{% else %}warning{% endif %} shadow-sm">
                        <div class="card-header bg-{% if freq == 'daily' %}success{% elif freq == 'weekly' %}primary{% else %}warning{% endif %} text-white d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">{{ habit.title }}</h5>
                            <div>
                                <a href="#" class="text-white" data-bs-toggle="modal" data-bs-target="#editHabitModal-{{ habit.id }}">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="badge bg-dark">
                                    {{ habit.frequency|ru_frequency }}
                                </span>
                                <small class="text-muted">
                                    –°–æ–∑–¥–∞–Ω–æ: {{ habit.created_at.strftime('%d.%m.%Y') }}
                                </small>
                            </div>
                            
                            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
                            {% set total_days = habit.progress.values()|length %}
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: {{ (habit.progress.values()|sum / total_days * 100) if total_days > 0 else 0 }}%"
                                     aria-valuenow="{{ habit.progress.values()|sum }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="{{ total_days }}">
                                    {{ ((habit.progress.values()|sum / total_days * 100)|round(1)) if total_days > 0 else 0 }}%
                                </div>
                            </div>
                            
                            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–º–µ—Ç–æ–∫ -->
                            <div class="habit-calendar" data-habit-id="{{ habit.id }}">
                                {% for date, status in generate_calendar(habit) %}
                                <div class="day 
                                    {% if status == 'completed' %}bg-success
                                    {% elif status == 'missed' %}bg-danger
                                    {% else %}bg-light{% endif %}" 
                                     data-date="{{ date }}"
                                     data-bs-toggle="tooltip" 
                                     title="{{ date|format_tooltip(habit) }}"
                                     {% if is_future_date(date) %}
                                     onclick="updateProgress('{{ habit.id }}', '{{ date }}')"
                                     style="cursor: pointer"
                                     {% else %}
                                     style="opacity:0.6; pointer-events:none"
                                     {% endif %}>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        –ù–µ—Ç {{ freq|ru_frequency }} –ø—Ä–∏–≤—ã—á–µ–∫
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% block scripts %}
<script>
function updateProgress(habitId, date) {
    fetch(`/habit/${habitId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ date: date })
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success') {
            const dayElement = document.querySelector(`[data-habit-id="${habitId}"][data-date="${date}"]`);
            dayElement.classList.toggle('bg-success', data.new_status);
            dayElement.classList.toggle('bg-light', !data.new_status);
        } else {
            alert(data.message);
        }
    })
    .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
}
</script>
{% endblock %}
{% endblock %}